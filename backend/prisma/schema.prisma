generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  displayName String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stats
  eloRating Int      @default(1000)
  totalPoints Int    @default(0)
  currentStreak Int  @default(0)
  longestStreak Int  @default(0)
  lastActiveDate DateTime?

  // Relations
  dailyQuizzes DailyQuizCompletion[]
  matches      Match[]
  matchResults MatchResult[]

  @@index([eloRating])
  @@index([username])
}

model DailyQuiz {
  id        String   @id @default(uuid())
  date      DateTime @unique
  questions Json
  createdAt DateTime @default(now())

  completions DailyQuizCompletion[]

  @@index([date])
}

model DailyQuizCompletion {
  id          String   @id @default(uuid())
  userId      String
  quizId      String
  score       Int
  answers     Json
  completedAt DateTime @default(now())

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz        DailyQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([userId, quizId])
  @@index([userId])
  @@index([quizId])
}

enum MatchType {
  RANKED
  CASUAL
}

enum MatchStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Match {
  id        String      @id @default(uuid())
  type      MatchType
  status    MatchStatus @default(WAITING)
  questions Json
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime    @default(now())

  participants User[]
  results      MatchResult[]

  @@index([status])
  @@index([type])
}

model MatchResult {
  id        String   @id @default(uuid())
  matchId   String
  userId    String
  score     Int
  answers   Json
  eloChange Int?
  createdAt DateTime @default(now())

  match     Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([matchId, userId])
  @@index([matchId])
  @@index([userId])
}

model Question {
  id           String   @id @default(uuid())
  type         String
  difficulty   Int
  question     String
  correctAnswer String
  options      Json
  explanation  String?
  language     String   @default("en")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([difficulty])
  @@index([language])
  @@index([type])
}
